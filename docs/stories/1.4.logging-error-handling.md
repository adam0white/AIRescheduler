# Story 1.4: Structured Logging & Error Handling

## Status
Done

## Story
**As a** developer,
**I want** structured JSON logging with correlation IDs and comprehensive error handling,
**so that** I can debug issues in production and maintain audit trail for all automated actions.

## Acceptance Criteria

1. Logger module `src/lib/logger.ts` emits structured JSON with timestamp, severity, correlation ID, and message
2. Correlation IDs generated for every RPC call and cron run
3. Correlation IDs propagate through all service function calls within a request
4. Log levels supported: `debug`, `info`, `warn`, `error`
5. All service functions log entry and exit with correlation ID
6. Error logs include stack traces and contextual metadata
7. RPC handler generates correlation ID and passes to services via context parameter
8. Scheduled handler generates correlation ID in format `cron-{timestamp}-{uuid}`
9. Dashboard displays correlation ID for manual actions in testing controls
10. Workers logs viewable in Wrangler with JSON formatting preserved

## Tasks / Subtasks

- [x] Create logger module (AC: 1, 4)
  - [x] Create `src/lib/logger.ts`
  - [x] Define `LogLevel` enum: debug, info, warn, error
  - [x] Implement `log` function accepting level, message, correlation ID, metadata
  - [x] Format log entries as JSON: `{ timestamp, level, correlationId, message, metadata }`
  - [x] Use `console.log` for output (captured by Workers logs)

- [x] Implement correlation ID generation (AC: 2, 8)
  - [x] Create `generateCorrelationId` function using crypto.randomUUID()
  - [x] RPC handler: generate ID in format `rpc-{timestamp}-{uuid}`
  - [x] Scheduled handler: generate ID in format `cron-{timestamp}-{uuid}`
  - [x] Store correlation ID in execution context

- [x] Create execution context pattern (AC: 3)
  - [x] Define `ExecutionContext` interface with `correlationId`, `env`, `logger`
  - [x] Update all service function signatures to accept `ctx: ExecutionContext`
  - [x] Pass correlation ID through entire call chain

- [x] Add logging to RPC handler (AC: 7)
  - [x] Generate correlation ID at start of RPC request
  - [x] Log RPC method, params, correlation ID
  - [x] Pass correlation ID to service functions via context
  - [x] Log RPC response or error with correlation ID
  - [x] Include correlation ID in error responses

- [x] Add logging to scheduled handler (AC: 8)
  - [x] Generate correlation ID at start of cron run
  - [x] Log cron start time, scheduled time, correlation ID
  - [x] Pass correlation ID to service pipeline functions
  - [x] Log cron completion with summary metrics

- [x] Add logging to service functions (AC: 5)
  - [x] Update all service stubs to accept `ctx: ExecutionContext`
  - [x] Log function entry with correlation ID and input parameters
  - [x] Log function exit with correlation ID and result summary
  - [x] Use `ctx.logger` for all log calls

- [x] Implement error logging (AC: 6)
  - [x] Catch exceptions in service functions
  - [x] Log error level with stack trace, correlation ID, and context
  - [x] Include service function name, input params, and error message
  - [x] Preserve error stack for debugging

- [x] Display correlation ID in dashboard (AC: 9)
  - [x] Update TestingControls component to show correlation ID after RPC call
  - [x] Display correlation ID in toast notifications
  - [x] Include correlation ID in error messages

- [x] Verify logging in Wrangler (AC: 10)
  - [x] Start Wrangler preview and trigger RPC call
  - [x] Check Workers logs for structured JSON entries
  - [x] Verify correlation ID appears in all related log entries
  - [x] Confirm log formatting is preserved and readable

## Dev Notes

### Relevant Source Tree
```
/
└── src/
    ├── lib/
    │   └── logger.ts                        # Structured logging module
    ├── rpc/
    │   └── handlers.ts                      # Updated with correlation ID
    ├── index.ts                             # Updated scheduled handler
    └── services/
        └── *.ts                             # All services use ExecutionContext
```

### Logger Module Design

**logger.ts structure:**
```typescript
export enum LogLevel {
  DEBUG = 'debug',
  INFO = 'info',
  WARN = 'warn',
  ERROR = 'error',
}

export interface LogEntry {
  timestamp: string;
  level: LogLevel;
  correlationId: string;
  message: string;
  metadata?: Record<string, any>;
}

export function log(
  level: LogLevel,
  correlationId: string,
  message: string,
  metadata?: Record<string, any>
): void {
  const entry: LogEntry = {
    timestamp: new Date().toISOString(),
    level,
    correlationId,
    message,
    metadata,
  };
  console.log(JSON.stringify(entry));
}

export function createLogger(correlationId: string) {
  return {
    debug: (message: string, metadata?: Record<string, any>) =>
      log(LogLevel.DEBUG, correlationId, message, metadata),
    info: (message: string, metadata?: Record<string, any>) =>
      log(LogLevel.INFO, correlationId, message, metadata),
    warn: (message: string, metadata?: Record<string, any>) =>
      log(LogLevel.WARN, correlationId, message, metadata),
    error: (message: string, metadata?: Record<string, any>) =>
      log(LogLevel.ERROR, correlationId, message, metadata),
  };
}
```

### Correlation ID Generation

**Pattern:**
```typescript
export function generateCorrelationId(prefix: 'rpc' | 'cron'): string {
  const timestamp = Date.now();
  const uuid = crypto.randomUUID();
  return `${prefix}-${timestamp}-${uuid}`;
}
```

**Examples:**
- RPC: `rpc-1731164532000-a1b2c3d4-e5f6-7890-abcd-ef1234567890`
- Cron: `cron-1731164532000-a1b2c3d4-e5f6-7890-abcd-ef1234567890`

### Execution Context Pattern

**ExecutionContext interface:**
```typescript
export interface ExecutionContext {
  correlationId: string;
  env: Env;
  logger: ReturnType<typeof createLogger>;
}

export function createContext(correlationId: string, env: Env): ExecutionContext {
  return {
    correlationId,
    env,
    logger: createLogger(correlationId),
  };
}
```

**Service function signature:**
```typescript
export async function pollWeather(
  ctx: ExecutionContext,
  request: WeatherPollRequest
): Promise<WeatherPollResponse> {
  ctx.logger.info('Weather poll started', { flightIds: request.flightIds });

  try {
    // Business logic
    const result = { snapshotsCreated: 0, flightsEvaluated: 0 };

    ctx.logger.info('Weather poll completed', result);
    return result;
  } catch (error) {
    ctx.logger.error('Weather poll failed', {
      error: error.message,
      stack: error.stack,
    });
    throw error;
  }
}
```

### RPC Handler Logging

**Updated handleRpc:**
```typescript
export async function handleRpc(request: Request, env: Env): Promise<Response> {
  const correlationId = generateCorrelationId('rpc');
  const ctx = createContext(correlationId, env);

  ctx.logger.info('RPC request received');

  const { method, params } = await request.json();
  ctx.logger.info('RPC method invoked', { method, params });

  try {
    let result;
    switch (method) {
      case 'weatherPoll':
        result = await weatherService.pollWeather(ctx, params);
        break;
      // ... other methods
    }

    ctx.logger.info('RPC request completed', { method, result });
    return jsonSuccess(result, correlationId);
  } catch (error) {
    ctx.logger.error('RPC request failed', {
      method,
      error: error.message,
      stack: error.stack,
    });
    return jsonError(error.message, 500, correlationId);
  }
}

function jsonSuccess(result: any, correlationId: string): Response {
  return new Response(JSON.stringify({ result, correlationId }), {
    headers: { 'Content-Type': 'application/json' },
  });
}
```

### Scheduled Handler Logging

**Updated scheduled handler:**
```typescript
export default {
  async scheduled(event: ScheduledEvent, env: Env, ctx: ExecutionContext): Promise<void> {
    const correlationId = generateCorrelationId('cron');
    const execCtx = createContext(correlationId, env);

    execCtx.logger.info('Cron triggered', {
      scheduledTime: event.scheduledTime,
      cron: event.cron,
    });

    try {
      // Orchestrate pipeline
      const weatherResult = await weatherService.pollWeather(execCtx, {});
      const rescheduleResult = await rescheduler.autoReschedule(execCtx, {});

      execCtx.logger.info('Cron completed', {
        weatherResult,
        rescheduleResult,
      });
    } catch (error) {
      execCtx.logger.error('Cron failed', {
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  },
};
```

### Log Entry Examples

**RPC call success:**
```json
{
  "timestamp": "2025-11-09T14:30:00.000Z",
  "level": "info",
  "correlationId": "rpc-1731164532000-a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "message": "RPC request completed",
  "metadata": {
    "method": "seedDemoData",
    "result": { "students": 3, "instructors": 2, "flights": 5 }
  }
}
```

**Service error:**
```json
{
  "timestamp": "2025-11-09T14:30:05.000Z",
  "level": "error",
  "correlationId": "rpc-1731164532000-a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "message": "Weather poll failed",
  "metadata": {
    "error": "WeatherAPI timeout",
    "stack": "Error: WeatherAPI timeout\n    at pollWeather (weather-service.ts:45:11)"
  }
}
```

### Important Notes from Architecture
- Structured logging enables filtering and analysis in production
- Correlation IDs link all operations within a single request or cron run
- Workers logs are available in Wrangler dashboard and via `wrangler tail`
- JSON formatting preserved in Workers logs for automated parsing
- Include sufficient context in error logs to debug without reproducing issue
- Never log sensitive data (API keys, PII) in metadata

### Testing

**Manual Verification Steps:**
1. Start Wrangler preview: `npm run dev`
2. Open browser console and access dashboard
3. Click "Seed Demo Data" button in Testing Controls
4. Observe Wrangler terminal output for structured JSON logs
5. Verify correlation ID appears in all log entries for that RPC call
6. Check dashboard toast displays correlation ID
7. Trigger RPC error by calling invalid method
8. Verify error log includes stack trace and correlation ID
9. Run `wrangler tail` in separate terminal to view live logs
10. Confirm JSON formatting preserved and readable

**Expected Outcomes:**
- All log entries formatted as valid JSON
- Correlation ID consistent across entire request lifecycle
- Service entry/exit logs appear with correlation ID
- Error logs include stack traces and contextual metadata
- Dashboard displays correlation ID in success/error toasts
- Wrangler logs viewable and filterable by correlation ID

## Change Log

| Date       | Version | Description              | Author        |
|------------|---------|--------------------------|---------------|
| 2025-11-09 | 1.0     | Initial story creation   | Bob (SM)      |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None - Implementation completed successfully without issues requiring debug logging.

### Completion Notes List
- Created comprehensive logger module with structured JSON logging
- Implemented correlation ID generation using crypto.randomUUID() with proper prefixes (rpc-/cron-)
- Created ExecutionContext pattern to propagate correlation IDs throughout the application
- Updated all 6 service modules to use ExecutionContext and log entry/exit with proper error handling
- Updated RPC handler to generate correlation IDs, create execution context, and log all operations
- Updated scheduled handler with correlation ID generation and logging
- Modified RPC schema to include correlationId in success responses
- Updated useRpc hook to return correlation IDs with all successful responses
- Enhanced TestingControls component to display correlation IDs in toast notifications
- All TypeScript type checking passed successfully
- Log format verified to output structured JSON with timestamp, level, correlationId, message, and metadata

### File List
**Created:**
- src/lib/logger.ts

**Modified:**
- src/rpc/handlers.ts
- src/rpc/schema.ts
- src/index.ts
- src/services/weather-service.ts
- src/services/rescheduler.ts
- src/services/seed-data.ts
- src/services/flight-list.ts
- src/services/notification-service.ts
- src/services/thresholds.ts
- src/dashboard/hooks/useRpc.ts
- src/dashboard/components/TestingControls.tsx

## QA Results

### Review Summary
**Reviewed By:** Quinn (QA Agent)
**Review Date:** 2025-11-09
**Decision:** PASS - APPROVED
**Gate File:** docs/qa/gates/epic-1.story-1.4-logging-error-handling.yml

Story 1.4 successfully implements comprehensive structured logging with correlation ID tracking across the entire application stack. All 10 acceptance criteria are met with excellent code quality, TypeScript compliance, and proper error handling patterns.

### Acceptance Criteria Results

| # | Criterion | Status | Evidence |
|---|-----------|--------|----------|
| 1 | Logger module emits structured JSON with timestamp, severity, correlation ID, and message | ✅ PASS | LogEntry interface with all required fields, JSON.stringify output |
| 2 | Correlation IDs generated for every RPC call and cron run | ✅ PASS | generateCorrelationId() called in handlers.ts:40 and index.ts:127 |
| 3 | Correlation IDs propagate through all service function calls | ✅ PASS | ExecutionContext pattern implemented across all 6 services |
| 4 | Log levels supported: debug, info, warn, error | ✅ PASS | LogLevel enum with all four levels, createLogger() methods |
| 5 | All service functions log entry and exit with correlation ID | ✅ PASS | Verified in all 6 services with ctx.logger.info() |
| 6 | Error logs include stack traces and contextual metadata | ✅ PASS | All services use try-catch with ctx.logger.error() including stack |
| 7 | RPC handler generates correlation ID and passes to services | ✅ PASS | handlers.ts creates context and passes to all service calls |
| 8 | Scheduled handler generates correlation ID with cron format | ✅ PASS | index.ts:127 uses generateCorrelationId('cron') |
| 9 | Dashboard displays correlation ID in testing controls | ✅ PASS | TestingControls.tsx shows IDs in toasts (lines 241-251) |
| 10 | Workers logs viewable in Wrangler with JSON formatting | ✅ PASS | console.log(JSON.stringify) preserves format, manual testing confirmed |

**Overall Acceptance Criteria Status: 10/10 PASS (100%)**

### Code Quality Assessment

**TypeScript Compliance:** ✅ EXCELLENT
- npm run lint passes with zero errors
- Strict type checking enforced throughout
- Proper interface definitions and type exports

**Code Structure:** ✅ EXCELLENT
- Clean separation of concerns (logger module, execution context pattern)
- Comprehensive JSDoc documentation
- Consistent patterns across all service implementations

**Error Handling:** ✅ EXCELLENT
- Comprehensive try-catch blocks in all services
- Proper error propagation with stack traces
- User-friendly error messages in RPC responses
- Contextual metadata preserved in all error logs

**Consistency:** ✅ EXCELLENT
- All 6 services follow identical ExecutionContext pattern
- Uniform entry/exit logging across all services
- Standardized correlation ID format: {prefix}-{timestamp}-{uuid}

### Testing Results

**Correlation ID Propagation:** ✅ VERIFIED
- RPC flow: Handler generates ID → createContext → passed to service → logged
- Cron flow: Scheduled handler generates ID → createContext → passed to services → logged
- ID format verified: rpc-{timestamp}-{uuid} and cron-{timestamp}-{uuid}
- All log entries within a request share the same correlation ID

**Log Format Verification:** ✅ VERIFIED
- Structured JSON with timestamp (ISO 8601)
- Proper severity levels (debug, info, warn, error)
- Correlation ID included in all entries
- Optional metadata support functioning correctly

**Dashboard Integration:** ✅ VERIFIED
- useRpc hook returns correlation IDs with all responses
- TestingControls displays correlation IDs in toast notifications
- Error responses include correlation IDs for traceability

**ExecutionContext Pattern:** ✅ VERIFIED (All 6 Services)
- weather-service.ts: Entry/exit logging with proper error handling
- rescheduler.ts: Consistent pattern implementation
- seed-data.ts: Comprehensive logging during data operations
- flight-list.ts: Query execution properly logged
- notification-service.ts: Notification creation logged
- thresholds.ts: Threshold loading logged

### Risk Assessment

**Technical Debt:** NONE identified
**Security Concerns:** NONE - Story explicitly addresses not logging sensitive data
**Performance Concerns:** NONE - Lightweight JSON logging appropriate for Workers
**Maintainability:** EXCELLENT - Well-structured, documented, and consistent

### Non-Functional Requirements

**Observability:** ✅ EXCELLENT
- Comprehensive logging with correlation IDs enables full request tracing
- All service operations logged with entry/exit points
- Metadata provides context for debugging

**Debuggability:** ✅ EXCELLENT
- Stack traces captured and logged for all errors
- Correlation IDs link all operations within a request
- Metadata includes function names, input parameters, and results

**Auditability:** ✅ EXCELLENT
- All operations logged with ISO 8601 timestamps
- Correlation IDs provide audit trail for all actions
- Structured JSON enables automated log analysis

### Files Reviewed (12 files)

**Created:**
- src/lib/logger.ts (104 lines) - APPROVED

**Modified:**
- src/rpc/handlers.ts (152 lines) - APPROVED
- src/rpc/schema.ts (140 lines) - APPROVED
- src/index.ts (152 lines) - APPROVED
- src/services/weather-service.ts (43 lines) - APPROVED
- src/services/rescheduler.ts (48 lines) - APPROVED
- src/services/seed-data.ts (205 lines) - APPROVED
- src/services/flight-list.ts (106 lines) - APPROVED
- src/services/notification-service.ts (60 lines) - APPROVED
- src/services/thresholds.ts (56 lines) - APPROVED
- src/dashboard/hooks/useRpc.ts (85 lines) - APPROVED
- src/dashboard/components/TestingControls.tsx (288 lines) - APPROVED

### Recommendations

**Improvements:** None required - implementation exceeds requirements

**Future Enhancements:**
- Consider adding log level configuration via environment variables for production vs development
- Consider implementing log sampling for high-frequency operations if needed in production

### Epic 1 Completion

With Story 1.4 approved, **ALL stories in Epic 1: Foundation & Infrastructure are now COMPLETE:**

✅ Story 1.1: Project Scaffolding & Build Configuration
✅ Story 1.2: D1 Database Schema & Migrations
✅ Story 1.3: Service Layer Architecture & RPC Bridge
✅ Story 1.4: Structured Logging & Error Handling

**Epic 1 Success Criteria Met:**
- ✅ Worker successfully deploys to Cloudflare with compatibility date 2024-11-08
- ✅ D1 database binding operational with all migrations applied
- ✅ RPC bridge between dashboard and Worker services functions correctly
- ✅ Vite build pipeline produces optimized React dashboard bundle
- ✅ Structured logging emits correlation-tagged JSON entries
- ✅ Manual testing controls in dashboard can trigger Worker operations

**Foundation is solid and ready for Epic 2: Weather Monitoring.**

### Final Decision

**Decision:** PASS - APPROVED FOR DEPLOYMENT
**Story Status:** Done
**Epic Status:** Complete
**Confidence Level:** HIGH

**Rationale:**
All acceptance criteria met with excellent implementation quality. Code demonstrates strong architectural patterns (ExecutionContext), comprehensive error handling, and proper TypeScript usage. Zero technical debt identified. Implementation exceeds minimum requirements by providing rich metadata in logs and comprehensive test coverage through manual verification. Ready for production use.
